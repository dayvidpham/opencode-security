{"id":"opencode-security-0av","title":"IMPL: Migrate flake.nix to uv2nix","description":"## Objective\n\nApply the research findings to rewrite flake.nix using uv2nix instead of buildPythonPackage.\n\n## Scope\n\n1. Replace buildPythonPackage with uv2nix workspace.loadWorkspace + mkVirtualEnv\n2. Add pyproject-nix, uv2nix, pyproject-build-systems inputs with follows\n3. Package: workspace.deps.default via mkVirtualEnv\n4. DevShell: workspace.deps.all with editable overlay (once blocker resolved)\n5. Retain non-Python devShell tools: bun, ruff, uv, LD_LIBRARY_PATH setup\n\n## Depends On\n\n- opencode-security-1in (RESEARCH task must resolve the editable blocker first)\n\n## Verification\n\n- nix flake check passes\n- nix build .#opencode-security-filter produces working CLI\n- nix develop enters shell with all tools (python, bun, uv, ruff)\n- Editable install works: code changes reflect without rebuild","status":"open","priority":2,"issue_type":"task","owner":"dayvidpham@gmail.com","created_at":"2026-02-19T00:31:44.187263518-08:00","created_by":"David Huu Pham","updated_at":"2026-02-19T00:31:44.187263518-08:00","dependencies":[{"issue_id":"opencode-security-0av","depends_on_id":"opencode-security-1in","type":"blocks","created_at":"2026-02-19T00:31:49.337195129-08:00","created_by":"David Huu Pham"}]}
{"id":"opencode-security-1ee","title":"REQUEST: Migrate flake.nix from buildPythonPackage to uv2nix","description":"## User Request (verbatim)\n\n\"Should be using uv2nix.\"\n\n## Context\n\nThe opencode-security repo has a working flake.nix (commit e5b1455) that uses nixpkgs buildPythonPackage + hatchling for the Python package and a devShell with Python 3.12, uv, ruff, mypy, and bun. The user wants to migrate to uv2nix for the Python package build and devShell.\n\n## Prior Research Findings\n\n1. **uv2nix inputs**: pyproject-nix, uv2nix, pyproject-build-systems with follows\n2. **workspace.loadWorkspace** reads pyproject.toml + uv.lock from workspaceRoot\n3. **mkPyprojectOverlay** + **mkEditablePyprojectOverlay** for package overlays\n4. **mkVirtualEnv** for building packages and devShell virtualenvs\n5. **workspace.deps.default** for production deps, **workspace.deps.all** for dev deps\n\n## Known Blocker\n\nThe editable overlay (needed for devShell) fails with hatchling because:\n- pyproject-nix's editable hook uses a custom build-editable script\n- That script invokes hatchling's build_editable() via subprocess\n- hatchling's editable mode requires the editables package\n- editables is NOT being injected into the build PYTHONPATH\n- Adding editables to build-system attrs does not fix it\n- The hello-world template works because it builds uv-build as part of the editable hook env\n- Our project does NOT build uv-build, causing the fallback to hatchling's native editable (which needs editables)\n\n## Key Question\n\nWhy does the hello-world template build uv-build for the editable hook but our project doesn't? The fix likely involves understanding how pyproject-nix resolves NIX_PYPROJECT_PYTHONPATH for editable builds and how uv-build gets included.\n\n## Source Code Examined\n\n- pyproject-nix/build/hooks/editable_hook/default.nix — creates editable-hook-env with libcst only\n- pyproject-nix/build/editable/src/build_editable/__init__.py — subprocess calls backend.build_editable()\n- pyproject-nix/build/hooks/pyproject-build-editable-hook.sh — sets PYTHONPATH with NIX_PYPROJECT_PYTHONPATH\n- pyproject-nix/build/hooks/pyproject-output-setup-hook.sh — adds out/site-packages to NIX_PYPROJECT_PYTHONPATH","status":"open","priority":2,"issue_type":"feature","owner":"dayvidpham@gmail.com","created_at":"2026-02-19T00:31:14.033110396-08:00","created_by":"David Huu Pham","updated_at":"2026-02-19T00:31:14.033110396-08:00"}
{"id":"opencode-security-1in","title":"RESEARCH: uv2nix editable overlay with hatchling — resolve build_editable blocker","description":"## Objective\n\nDeep-dive into pyproject-nix and uv2nix source code to understand why the editable overlay fails with hatchling in our project but works in the hello-world template.\n\n## Research Questions\n\n### Q1: Why does hello-world build uv-build but our project doesn't?\n- Compare the hello-world template build logs (uv_build-0.10.2 is built) vs our project (no uv-build)\n- Hypothesis: uv-build replaces hatchling for editable builds when available, sidestepping the editables dependency\n- Check if uv-build is declared as a build-system dep in the pyproject-build-systems overlay for hello-world but not for us\n\n### Q2: How does NIX_PYPROJECT_PYTHONPATH get populated?\n- pyproject-output-setup-hook.sh adds $out/site-packages to NIX_PYPROJECT_PYTHONPATH\n- This is a setup hook propagated by installed packages\n- The editable build hook uses this: env PYTHONPATH=\"${NIX_PYPROJECT_PYTHONPATH}:${PYTHONPATH}\" build-editable\n- Need to trace: which packages' setup hooks have already run before the editable build phase\n\n### Q3: Is uv-build the correct fix?\n- The pyproject-nix build hook (non-editable) explicitly uses @uv@/bin/uv build\n- The editable hook uses a custom build-editable script instead\n- Does the editable overlay need uv-build as a build-system dependency?\n\n### Q4: What does mkEditablePyprojectOverlay actually produce?\n- Read the uv2nix source for mkEditablePyprojectOverlay\n- What attrs does it set on the package? Does it change the build hook?\n- Does it add any build-system dependencies automatically?\n\n## Sources to Read\n\n1. pyproject-nix repo (cloned at ~/codebases/pyproject-nix/):\n   - build/lib/renderers.nix — how packages are rendered, build-system resolution\n   - build/hooks/default.nix — pyprojectEditableHook definition\n   - build/hooks/pyproject-build-editable-hook.sh — the actual build phase\n\n2. uv2nix repo (clone or nix store):\n   - lib/workspace.nix or similar — mkEditablePyprojectOverlay implementation\n   - templates/hello-world/flake.nix — reference template\n\n3. pyproject-build-systems repo:\n   - Check if uv-build is included in the wheel overlay\n   - Check what build-system deps are declared for hatchling\n\n## Acceptance Criteria\n\n- [ ] Root cause identified: why uv-build is absent in our editable build\n- [ ] Fix validated: editable devShell builds and enters successfully\n- [ ] Documented: the correct pattern for hatchling + uv2nix editable overlay","status":"open","priority":2,"issue_type":"task","owner":"dayvidpham@gmail.com","created_at":"2026-02-19T00:31:33.075642913-08:00","created_by":"David Huu Pham","updated_at":"2026-02-19T00:31:33.075642913-08:00","dependencies":[{"issue_id":"opencode-security-1in","depends_on_id":"opencode-security-1ee","type":"blocks","created_at":"2026-02-19T00:31:49.31411151-08:00","created_by":"David Huu Pham"}]}
